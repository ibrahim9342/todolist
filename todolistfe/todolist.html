<!DOCTYPE html>
<html lang="en">

<head>
    <title>ToDoList</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src=" https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script>

</head>

<body>

    <div class="container">
        <h4><div id="wname"> </div></h4>
        <h2>ToDoList</h2>

        <button type="button" class="btn btn-info btn-lg" data-toggle="modal" style="margin-bottom:10px!important" data-target="#newtodo">Yeni Ekle</button>

        <button type="button" onclick="exit()" class="btn btn-danger btn-lg" style="margin-bottom:10px!important;float:right">Çıkış Yap</button>

        <table id="tododatatable" class="table" cellspacing="0">
            <thead>
                <tr>
                    <th>ToDoList Adı</th>
                    <th>Oluşturma Tarihi</th>
                    <th>İşlemler</th>
                </tr>
            </thead>
        </table>
    </div>

    <div class="modal fade" id="newtodo" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Yeni Ekle</h4>
                </div>
                <div class="modal-body">
                    <p>
                        <form id="newToDoForm">
                            <input class="form-control" id="listName" name="listName" placeholder="Yapılacak İş Adı" required="true">
                        </form>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Kapat</button>
                    <button onclick="save()" class="btn btn-info">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            if (sessionStorage.getItem("id") === null) {
                document.location = "index.html";
            }
            $("#wname").html("Hoşgeldin " + sessionStorage.getItem("uname"));

            list();
        });

        function exit() {
            sessionStorage.setItem("id", "");
            document.location = "index.html";
        }

        function list() {
            $('#tododatatable').DataTable({
                processing: true,
                bPaginate: false,
                ajax: {
                    url: "http://localhost:9090/todolist/" + sessionStorage.getItem("id"),
                    type: "GET",
                    dataSrc: function(json) {
                        for (var i = 0; i < json.length; i++) {
                            var obj = json[i];
                            console.log(obj);

                            obj["detail"] = "<a href='javascript:redirect(\"" + obj["id"] + "\",\"" + obj["listName"] + "\");' style='color:blue;'>Detay</a><a href='javascript:deleteToDo(\"" + obj["id"] + "\");' style='color:red;margin-left:5px!important;'>Sil</a>";
                            json[i] = obj;
                        }
                        return json;
                    }
                },
                "columns": [{
                    "data": "listName"
                }, {
                    "data": "createdAt"
                }, {
                    "data": "detail"
                }]
            });

        }

        function redirect(id, name) {
            sessionStorage.setItem("listid", id);
            sessionStorage.setItem("listname", name);
            document.location = "todoitem.html";
        }

        function deleteToDo(id) {
            var targeturl = "http://localhost:9090/todolist/delete/" + id;
            $.ajax({
                url: targeturl,
                type: "DELETE",
                crossDomain: true,
                contentType: 'application/json; charset=utf-8',
                success: function(resultData) {
                    if (resultData === null) {
                        alert("Hata Oluştu");
                    } else {
                        var dataTable = $('#tododatatable').dataTable();
                        dataTable.fnClearTable();
                        dataTable.fnDraw();
                        dataTable.fnDestroy();
                        list();
                    }
                },
                error: function() {
                    alert("Hata Oluştu");
                }
            });
        }

        function save() {
            var targeturl = "http://localhost:9090/todolist/save";
            var obj = {
                listName: document.getElementById("listName").value,
                userid: sessionStorage.getItem("id")
            };
            document.getElementById("listName").value = "";
            $.ajax({
                url: targeturl,
                type: "POST",
                data: JSON.stringify(obj),
                crossDomain: true,
                contentType: 'application/json; charset=utf-8',
                success: function(resultData) {
                    $('#newtodo').modal('hide');
                    if (resultData === null) {
                        alert("Kayıt Oluştrulurken Bir Hata Oldu");
                    } else {
                        var dataTable = $('#tododatatable').dataTable();
                        dataTable.fnClearTable();
                        dataTable.fnDraw();
                        dataTable.fnDestroy();
                        list();
                    }
                },
                error: function() {
                    alert("Bir Hata Oluştu");
                }
            });

        }
    </script>

</body>

</html>
